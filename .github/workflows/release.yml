name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: vitals-linux-amd64
            deb_arch: amd64
            rpm_arch: x86_64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            name: vitals-linux-arm64
            deb_arch: arm64
            rpm_arch: aarch64
          - target: x86_64-apple-darwin
            os: macos-latest
            name: vitals-darwin-amd64
          - target: aarch64-apple-darwin
            os: macos-latest
            name: vitals-darwin-arm64
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Determine version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Package tarball
        shell: bash
        run: |
          mkdir -p staging
          cp target/${{ matrix.target }}/release/vitals staging/
          chmod +x staging/vitals
          cd staging && tar czf ../${{ matrix.name }}.tar.gz vitals && cd ..
          sha256sum ${{ matrix.name }}.tar.gz > ${{ matrix.name }}.tar.gz.sha256 || shasum -a 256 ${{ matrix.name }}.tar.gz > ${{ matrix.name }}.tar.gz.sha256

      - name: Package binary
        run: |
          cp target/${{ matrix.target }}/release/vitals ${{ matrix.name }}
          chmod +x ${{ matrix.name }}

      - name: Build .deb
        if: startsWith(matrix.os, 'ubuntu')
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARCH="${{ matrix.deb_arch }}"
          PKG="vitals_${VERSION}_${ARCH}"
          mkdir -p "${PKG}/DEBIAN" "${PKG}/usr/bin" "${PKG}/usr/share/doc/vitals"
          cp "target/${{ matrix.target }}/release/vitals" "${PKG}/usr/bin/"
          chmod 755 "${PKG}/usr/bin/vitals"
          cp LICENSE "${PKG}/usr/share/doc/vitals/copyright"
          printf 'Package: vitals\nVersion: %s\nSection: devel\nPriority: optional\nArchitecture: %s\nMaintainer: onuroluc <github.com/onuroluc>\nHomepage: https://github.com/onuroluc/vitals\nDescription: Universal development environment doctor\n Auto-detects your project stack and diagnoses runtime versions,\n dependencies, Docker services, ports, and environment variables.\n' "$VERSION" "$ARCH" > "${PKG}/DEBIAN/control"
          dpkg-deb --build --root-owner-group "${PKG}"
          mv "${PKG}.deb" "vitals_${VERSION}_${ARCH}.deb"

      - name: Build .rpm
        if: startsWith(matrix.os, 'ubuntu')
        shell: bash
        run: |
          sudo apt-get install -y rpm
          VERSION="${{ steps.version.outputs.version }}"
          RPM_ARCH="${{ matrix.rpm_arch }}"
          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          cp "target/${{ matrix.target }}/release/vitals" rpmbuild/SOURCES/
          printf 'Name: vitals\nVersion: %s\nRelease: 1\nSummary: Universal development environment doctor\nLicense: MIT\nURL: https://github.com/onuroluc/vitals\nAutoReqProv: no\n\n%%description\nAuto-detects your project stack and diagnoses runtime versions,\ndependencies, Docker services, ports, and environment variables.\n\n%%install\nmkdir -p %%{buildroot}/usr/bin\ncp %%{_sourcedir}/vitals %%{buildroot}/usr/bin/vitals\n\n%%files\n/usr/bin/vitals\n' "$VERSION" > rpmbuild/SPECS/vitals.spec
          rpmbuild --define "_topdir $(pwd)/rpmbuild" --define "_sourcedir $(pwd)/rpmbuild/SOURCES" --target "${RPM_ARCH}" -bb rpmbuild/SPECS/vitals.spec
          cp rpmbuild/RPMS/${RPM_ARCH}/*.rpm "vitals-${VERSION}-1.${RPM_ARCH}.rpm"

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: |
            ${{ matrix.name }}
            ${{ matrix.name }}.tar.gz
            ${{ matrix.name }}.tar.gz.sha256
            *.deb
            *.rpm

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List release assets
        run: ls -lhR artifacts/ || ls -lh .

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            *.tar.gz
            *.sha256
            *.deb
            *.rpm
            vitals-*
          generate_release_notes: true
